# KVM#section02 : virshによる仮想マシン構築

実際にKVMで仮想マシンを構築してみましょう．  
今回は，実習用の環境を用意出来なかったので，スクリーンで実践するだけになります．

# virsh とは

virshはコマンドラインから仮想マシンの操作ができるコマンドです．  
libvirtを利用しています．  
libvirt(library virtual) は様々な仮想化ソフトウェアを扱える共通API集のようなものです．

# virshの使い方

単純にvirshと入力するとvirsh専用のプロンプトが起動します．

```
# virsh
virsh にようこそ、仮想化対話式ターミナルです。

入力: 'help' コマンドのヘルプ
      'quit' 終了

virsh #
```

ずっとvirshを叩き続ける場合はこっちの方が楽ですが，あまり無いと思います．  
直接サブコマンドを使いたいときは`virsh サブコマンド`とすれば，専用プロンプトを起動せずに操作出来ます．

`virsh help`と打ってみましょう．
利用できるサブコマンド一覧とそれらの説明が見れます．

# 仮想マシンの作成

実際に仮想マシンを作成してみましょう．  
作成する際には，仮想マシンの定義ファイルが必要になります．  

何をかけば良いのか分からない場合は，定義済みのものを利用しましょう．
`dumpxml`コマンドで作成済みの仮想マシンの情報を出力出来ます．
定義ファイルは`/etc/libvirt/qemu/`にあります．

```
virsh dumpxml 仮想マシン > 新しい定義ファイル
```

複製したものをそのまま使用するとユニークが値が被ってしまうため作成出来ません．

- name
- uuid
- macアドレス
- imageのパス

を変更しましょう．

また，ディスクイメージも同じものを使うことが出来ないので，複製して起きましょう．

```
cp /var/lib/libvirt/images/ディスク名 /var/lib/libvirt/images/新しいディスク名
```

変更・複製が出来たら，`define`コマンドで仮想マシンを作成します．

```
virsh define 新しい定義ファイル
```

このとき，`create`コマンドを使うとそのまま起動します．

## 仮想マシンの起動

`start`コマンドで仮想マシンを起動します．

```
virsh start 仮想マシン名
```

起動するとconsoleコマンドでログイン出来ます．  

```
virsh console 仮想マシン名
```

ttyの設定などをしていないと出来ないかもしれません．  
その場合は以下のサイトなどを参考にしてみてください．  
- [virsh consoleの設定](http://knqyf263.hatenablog.com/entry/2014/01/13/200509)
- [KVM のゲストOS(Linux)にコンソールログインするための設定](http://dotnsf.blog.jp/archives/980512.html)


# 起動速度の比較

virtual box(Vangrant)とKVMとDockerで起動速度を比較してみましょう．  
OSや設定やcuiかguiかで違ってくるとは思いますが，ほぼおなじ構成のもので比較してみます．

```
time vagrant up
time virsh start 仮想マシン名
time docker run 仮想マシン名
```

---

これでKVM入門講座は終了です．  
他のツールを使った構築方法や，KVMに使われている技術などを付録に追記する予定です．  
[README](./README.md) に戻る．
